<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.554">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>DSAN-5000: Project - EDA</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
.image-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        align-items: center;
    }
    
.distribution-image {
        width: 800px;  
        height: auto;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../assets/gu-logo.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">DSAN-5000: Project</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../instructions/overview.html"> 
<span class="menu-text">Instructions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../collaborators.html"> 
<span class="menu-text">Collaborators</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../report/report.html"> 
<span class="menu-text">Report</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-technical-details" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Technical details</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-technical-details">    
        <li>
          <a class="dropdown-item" href="../../technical-details/data-collection/main.html">
            <span class="dropdown-text">Data-collection</span></a>
            <a class="dropdown-item" href="../../technical-details/data-cleaning/main.html">
             <span class="dropdown-text">Data-cleaning</span></a>
             <a class="dropdown-item" href="../../technical-details/unsupervised-learning/main.html">
              <span class="dropdown-text">Unsupervised-learning</span></a>
              <a class="dropdown-item" href="../../technical-details/eda/main.html">
                <span class="dropdown-text">EDA</span></a>
                <a class="dropdown-item" href="../../technical-details/supervised-learning/main.html">
                  <span class="dropdown-text">Supervised-learning</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#instructions" id="toc-instructions" class="nav-link active" data-scroll-target="#instructions">Instructions</a></li>
  <li><a href="#data-collection" id="toc-data-collection" class="nav-link" data-scroll-target="#data-collection">EDA:</a>
  <ul class="collapse">
  <li><a href="#saving-the-raw-data" id="toc-saving-the-raw-data" class="nav-link" data-scroll-target="#saving-the-raw-data">Saving the raw data</a></li>
  <li><a href="#requirements" id="toc-requirements" class="nav-link" data-scroll-target="#requirements">Requirements:</a></li>
  </ul></li>
  <li><a href="#what-do-include-on-this-page" id="toc-what-do-include-on-this-page" class="nav-link" data-scroll-target="#what-do-include-on-this-page">What do include on this page</a></li>
  <li><a href="#methods" id="toc-methods" class="nav-link" data-scroll-target="#methods">Methods</a></li>
  <li><a href="#code" id="toc-code" class="nav-link" data-scroll-target="#code">Code</a>
  <ul class="collapse">
  <li><a href="#exmaple" id="toc-exmaple" class="nav-link" data-scroll-target="#exmaple">Exmaple</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">EDA</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- After digesting the instructions, you can delete this cell, these are assignment instructions and do not need to be included in your final submission.  -->
<section id="instructions" class="level1">
<h1>Instructions</h1>
<p>On this page, you will focus on <strong>EDA</strong>, which is an essential step for future analysis. You should have already selected a specific data-science question that can be addressed in a data-driven way.</p>
<p>It is recommended that you focus on one or two of the following data format, <strong>text</strong>, <strong>tabular</strong>, <strong>image</strong>, <strong>geospatial</strong>, or <strong>network</strong> data.</p>
<p><strong>Tabular</strong> (e.g.&nbsp;CSV files) and <strong>text</strong> formats are highly recommended, as these are covered most thoroughly in the course. Deviating from these formats may require additional work on your end. Please avoid <strong>timeseries</strong> data formats, as these require special methods not covered in the course. You can include as many additional formats as you want. Your project will revolve around the data you gather and will include EDA, analysis, visualization, and storytelling.</p>
</section>
<section id="data-collection" class="level1">
<h1>EDA:</h1>
<p>Begin gathering your data and document the methods and sources on the <strong>EDA</strong> page of your project. Include screenshots to illustrate the EDA process without displaying entire datasets. Ensure <strong>transparency</strong> so anyone can replicate your work.</p>
<section id="saving-the-raw-data" class="level2">
<h2 class="anchored" data-anchor-id="saving-the-raw-data">Saving the raw data</h2>
<ul>
<li>During the collection phase, save the collected data locally to the <code>raw-data</code> folder, in the root of the project, for later processing.
<ul>
<li>Do not sync this folder to GitHub.</li>
</ul></li>
<li>You should also save files you download manually from online to this folder</li>
</ul>
</section>
<section id="requirements" class="level2">
<h2 class="anchored" data-anchor-id="requirements">Requirements:</h2>
<ul>
<li>Your data must be relevant to the project’s overall goals and help solve your research questions.</li>
<li>You must use <strong>at least one API</strong> to collect your data.</li>
<li>Ensure you have at least one <strong>regression target</strong>: a continuous quantity that can be used for regression prediction with other features.</li>
<li>Ensure you have at least one <strong>binary classification target</strong>: a two-class (A,B) label that can be predicted using other features.</li>
<li>Ensure you have at least one <strong>multi-classification target</strong>: a multi-class (A,B,C …) label that can be predicted using other features.</li>
<li><strong>Do not use a Kaggle topic</strong>—this project is meant to simulate a real-world project. Kaggle datasets are typically too clean and have already been prepped for analysis, which doesn’t align with the project’s goals.</li>
</ul>
<p>Remember, data is about <strong>quality</strong>, not quantity, so avoid handling large datasets unless necessary. Focus on data that tells a compelling story and supports the techniques you will apply (e.g., clustering, classification, regression).</p>
</section>
</section>
<section id="what-do-include-on-this-page" class="level1">
<h1>What do include on this page</h1>
<p>To ensure clarity and transparency throughout your project, your EDA documentation should include the following:</p>
<ol start="0" type="1">
<li><p><strong>Include all code used for EDA</strong> in the notebook below</p></li>
<li><p><strong>Data Source Information</strong></p>
<ul>
<li>Specify where the data comes from, whether public datasets, APIs, or original collection.</li>
<li>Provide links to datasets or API documentation and explain their relevance to the project.</li>
</ul></li>
<li><p><strong>EDA Methods</strong></p>
<ul>
<li>If you used an API or web scraping, explain the tools (e.g., <code>BeautifulSoup</code>, <code>Selenium</code>) and the process.</li>
<li>Include links to your code for replicating EDA.</li>
</ul></li>
<li><p><strong>Data Structure and Format</strong></p>
<ul>
<li>Describe the structure of your raw data (e.g., rows, columns, data types) and its format (CSV, JSON, etc.).</li>
</ul></li>
<li><p><strong>Linking to Data</strong></p>
<ul>
<li>Include links to the <strong>raw dataset</strong>, ensuring transparency and allowing replication.</li>
</ul></li>
<li><p><strong>Code and Reproducibility</strong></p>
<ul>
<li>Link to all relevant code, including EDA , with clear documentation to enable replication.</li>
</ul></li>
<li><p><strong>Transparency and Replicability</strong></p>
<ul>
<li>Ensure your entire workflow is transparent and reproducible by linking all data, code, and documentation. This allows others to follow your process from start to finish.</li>
</ul></li>
</ol>
</section>
<section id="methods" class="level1">
<h1>Methods</h1>
<p>Document an overview summary of the methods you used on this page</p>
</section>
<section id="code" class="level1">
<h1>Code</h1>
<p>Here you provide your source code used to do this section of the project</p>
<section id="exmaple" class="level2">
<h2 class="anchored" data-anchor-id="exmaple">Exmaple</h2>
<p>In the following code, we first utilized the requests library to retrieve the HTML content from the Wikipedia page. Afterward, we employed BeautifulSoup to parse the HTML and locate the specific table of interest by using the find function. Once the table was identified, we extracted the relevant data by iterating through its rows, gathering country names and their respective populations. Finally, we used Pandas to store the collected data in a DataFrame, allowing for easy analysis and visualization. The data could also be optionally saved as a CSV file for further use.<span class="citation" data-cites="gpt4o"><sup><a href="#ref-gpt4o" role="doc-biblioref">1</a></sup></span></p>

<div id="cell-6" class="cell" data-execution_count="2">
  <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">
    <span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas as pd</span>
    <span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy as np</span>
    <span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot as plt</span>
    <span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn as sns</span>
    <span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
    <span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
    <span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans, DBSCAN</span>
    <span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
    <span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
    <span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
    <span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.cluster.hierarchy <span class="im">import</span> dendrogram, linkage, fcluster</span>
    <span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> silhouette_score</span>
    
    <span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># File paths for all datasets</span></span>
    <span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>file_paths = {</span>
    <span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sp500"</span>: <span class="st">"../../data/processed-data/S&P_500_cleaned.csv"</span>,</span>
    <span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"oil"</span>: <span class="st">"../../data/processed-data/Crude_Oil_cleaned.csv"</span>,</span>
    <span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gold"</span>: <span class="st">"../../data/processed-data/Gold_cleaned.csv"</span>,</span>
    <span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nasdaq"</span>: <span class="st">"../../data/processed-data/Nasdaq_cleaned.csv"</span>,</span>
    <span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"dow_jones"</span>: <span class="st">"../../data/processed-data/Dow_Jones_cleaned.csv"</span></span>
    <span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>}</span>
    
    <span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Load all datasets into a dictionary</span></span>
    <span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>datasets = {name: pd.read_csv(path, parse_dates=<span class="st">["index"]</span>) <span class="kw">for</span> name, path <span class="kw">in</span> file_paths.items()}</span>
    
    <span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize merged_data with S&P 500 dataset</span></span>
    <span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>asset_data = datasets[<span class="st">"sp500"</span>]</span>
    
    <span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge datasets iteratively with others</span></span>
    <span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> name, df <span class="kw">in</span> datasets.items():</span>
    <span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> name != <span class="st">"sp500"</span>:  <span class="co"># Skip the first dataset (already initialized)</span></span>
    <span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        asset_data = pd.merge(asset_data, df, on=<span class="st">"index"</span>, suffixes=(None, <span class="st">f"_{name}"</span>))</span>
    
    <span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle missing data by forward-filling and dropping any remaining NaNs</span></span>
    <span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>asset_data = asset_data.fillna(method=<span class="st">'ffill'</span>).dropna()</span>
    
    <span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>sp500_columns = [</span>
    <span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Open'</span>, <span class="st">'High'</span>, <span class="st">'Low'</span>, <span class="st">'Close'</span>, <span class="st">'Volume'</span>, <span class="st">'MA_50'</span>, <span class="st">'MA_200'</span>, </span>
    <span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Daily_Return'</span>, <span class="st">'Volatility'</span>, <span class="st">'RSI'</span>, <span class="st">'EMA_12'</span>, <span class="st">'EMA_26'</span>, <span class="st">'MACD'</span>, </span>
    <span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Signal_Line'</span>, <span class="st">'High_Low'</span>, <span class="st">'High_Close'</span>, <span class="st">'Low_Close'</span>, <span class="st">'True_Range'</span>, </span>
    <span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ATR'</span>, <span class="st">'OBV'</span>, <span class="st">'RSI_Lag1'</span>, <span class="st">'MACD_Lag1'</span>, <span class="st">'Close_Lag1'</span>, <span class="st">'Volume_Lag1'</span>, </span>
    <span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RSI_Lag2'</span>, <span class="st">'MACD_Lag2'</span>, <span class="st">'Close_Lag2'</span>, <span class="st">'Volume_Lag2'</span>, <span class="st">'RSI_Lag3'</span>, </span>
    <span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MACD_Lag3'</span>, <span class="st">'Close_Lag3'</span>, <span class="st">'Volume_Lag3'</span>, <span class="st">'Target'</span>, <span class="st">'Future_Return_5D'</span></span>
    <span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>]</span>
    
    <span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the prefix "_sp500" only to the SP500 columns</span></span>
    <span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>asset_data.rename(columns={col: <span class="st">f"{col}_sp500"</span> <span class="kw">for</span> col <span class="kw">in</span> sp500_columns}, inplace=<span class="va">True</span>)</span>
    
    <span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the first few rows to check the new column names</span></span>
    <span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>asset_data.head()</span>
    <span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the merged dataset</span></span>
    <span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>asset_data.to_csv(<span class="st">"../../data/processed-data/merged_assets.csv"</span>, index=<span class="va">False</span>)</span>  </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
  <div class="cell-output cell-output-stdout">
  </div>
  </div>
    
    
    <div id="cell-6" class="cell" data-execution_count="2">
      <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">
      
        <span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load macroeconomic data (monthly data)</span></span>
        <span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>macro_data = pd.read_csv(<span class="st">"../../data/processed-data/macro_series_cleaned.csv"</span>)</span>
        <span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>macro_data.head()</span>
        
        <span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Ensure the `date` column is in datetime format</span></span>
        <span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>macro_data[<span class="st">'date'</span>] = pd.to_datetime(macro_data[<span class="st">'date'</span>])</span>
        
        <span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract year and month from the `date` column</span></span>
        <span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>macro_data[<span class="st">'year_month'</span>] = macro_data[<span class="st">'date'</span>].dt.to_period(<span class="st">'M'</span>).astype(<span class="va">str</span>)  <span class="co"># Format: YYYY-MM</span></span>
        
        <span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing values and fill them</span></span>
        <span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>macro_data.fillna(method=<span class="st">'ffill'</span>, inplace=<span class="va">True</span>)  <span class="co"># Forward fill any missing values</span></span>
        
        <span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Generate derived features</span></span>
        <span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate year-over-year (YoY) and month-over-month (MoM) growth rates</span></span>
        <span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>macro_data[<span class="st">'GDP_YoY'</span>] = macro_data[<span class="st">'GDP'</span>].pct_change(<span class="nu">12</span>) * <span class="nu">100</span>  <span class="co"># YoY growth rate for GDP (%)</span></span>
        <span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>macro_data[<span class="st">'GDP_MoM'</span>] = macro_data[<span class="st">'GDP'</span>].pct_change(<span class="nu">1</span>) * <span class="nu">100</span>   <span class="co"># MoM growth rate for GDP (%)</span></span>
        <span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>macro_data[<span class="st">'CPI_YoY'</span>] = macro_data[<span class="st">'CPI'</span>].pct_change(<span class="nu">12</span>) * <span class="nu">100</span>  <span class="co"># YoY growth rate for CPI (%)</span></span>
        
        <span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create lagged features</span></span>
        <span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>macro_data[<span class="st">'GDP_Lag1'</span>] = macro_data[<span class="st">'GDP'</span>].shift(<span class="nu">1</span>)  <span class="co"># GDP lagged by one month</span></span>
        <span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>macro_data[<span class="st">'CPI_Lag1'</span>] = macro_data[<span class="st">'CPI'</span>].shift(<span class="nu">1</span>)  <span class="co"># CPI lagged by one month</span></span>
        
        <span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Load asset data (daily data)</span></span>
        <span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>asset_data[<span class="st">'date'</span>] = pd.to_datetime(asset_data[<span class="st">'index'</span>])  <span class="co"># Convert `index` to datetime</span></span>
        
        <span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract year and month from the asset data</span></span>
        <span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>asset_data[<span class="st">'year_month'</span>] = asset_data[<span class="st">'date'</span>].dt.to_period(<span class="st">'M'</span>).astype(<span class="va">str</span>)  <span class="co"># Format: YYYY-MM</span></span>
        
        <span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Downsample asset data (daily frequency -> monthly frequency)</span></span>
        <span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by `year_month` and take the last available data for each month</span></span>
        <span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>asset_data_monthly = asset_data.groupby(<span class="st">'year_month'</span>).last().reset_index()</span>
        
        <span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Merge macroeconomic data with asset data</span></span>
        <span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge both datasets based on the `year_month` column</span></span>
        <span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>macro_data = pd.merge(macro_data, asset_data_monthly, on=<span class="st">'year_month'</span>, how=<span class="st">'left'</span>)</span>
        
        <span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle missing values in the merged dataset</span></span>
        <span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>macro_data.fillna(method=<span class="st">'ffill'</span>, inplace=<span class="va">True</span>)  <span class="co"># Forward fill missing values</span></span>
        <span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>macro_data.fillna(method=<span class="st">'bfill'</span>, inplace=<span class="va">True</span>)  <span class="co"># Backward fill missing values (if needed)</span></span>
        
        <span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Standardize the data</span></span>
        <span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Select the columns to be standardized</span></span>
        <span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>columns_to_scale = [<span class="st">'GDP'</span>, <span class="st">'CPI'</span>, <span class="st">'Unemployment'</span>, <span class="st">'FedFundsRate'</span>, <span class="st">'M2'</span>,</span>
        <span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'Umscent'</span>, <span class="st">'real_estate'</span>, <span class="st">'Exports'</span>, <span class="st">'Imports'</span>,</span>
        <span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'GDP_YoY'</span>, <span class="st">'GDP_MoM'</span>, <span class="st">'CPI_YoY'</span>, <span class="st">'GDP_Lag1'</span>, <span class="st">'CPI_Lag1'</span>]</span>
        
        <span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>scaler = StandardScaler()</span>
        <span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply standard scaling (mean = 0, std dev = 1) to the selected columns</span></span>
        <span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>macro_data[columns_to_scale] = scaler.fit_transform(macro_data[columns_to_scale])</span>
        
        <span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Inspect the processed data</span></span>
        <span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(macro_data.head())</span>
        
        <span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the processed dataset to a CSV file</span></span>
        <span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>macro_data.to_csv(<span class="st">"../../data/processed-data/macro_data.csv"</span>, index=<span class="va">False</span>)</span>      </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
      <div class="cell-output cell-output-stdout">
      </div>
      </div>
      <pre><code> date_x       GDP       CPI  Unemployment  FedFundsRate        M2  \
        0 2000-01-01 -1.419333 -1.594756     -0.867414      1.754717 -1.259868   
        1 2000-02-01 -1.371109 -1.576251     -0.816379      1.893549 -1.257353   
        2 2000-03-01 -1.371109 -1.549815     -0.867414      1.953048 -1.251527   
        3 2000-04-01 -1.371735 -1.552459     -0.969482      2.037339 -1.240917   
        4 2000-05-01 -1.371109 -1.544528     -0.867414      2.161296 -1.243205   
        
            Umscent  real_estate   Exports   Imports  ...  MACD_Lag2_dow_jones  \
        0  2.199732    -1.446673 -1.458048 -1.614811  ...           -65.554617   
        1  2.146820    -1.436692 -1.391110 -1.523412  ...           -65.554617   
        2  1.829348    -1.421047 -1.391110 -1.523412  ...           -65.554617   
        3  1.988084    -1.402256 -1.395372 -1.552202  ...           -65.554617   
        4  2.101467    -1.381961 -1.391110 -1.523412  ...           -65.554617   
        
           Close_Lag2_dow_jones  Volume_Lag2_dow_jones  RSI_Lag3_dow_jones  \
        0          10090.900391            160980000.0           46.925369   
        1          10090.900391            160980000.0           46.925369   
        2          10090.900391            160980000.0           46.925369   
        3          10090.900391            160980000.0           46.925369   
        4          10090.900391            160980000.0           46.925369   
        
           MACD_Lag3_dow_jones  Close_Lag3_dow_jones Volume_Lag3_dow_jones  \
        0           -50.963179          10222.030273           172820000.0   
        1           -50.963179          10222.030273           172820000.0   
        2           -50.963179          10222.030273           172820000.0   
        3           -50.963179          10222.030273           172820000.0   
        4           -50.963179          10222.030273           172820000.0   
        
          Target_dow_jones  Future_Return_5D_dow_jones     date_y  
        0              0.0                   -0.034598 2001-08-31  
        1              0.0                   -0.034598 2001-08-31  
        2              0.0                   -0.034598 2001-08-31  
        3              0.0                   -0.034598 2001-08-31  
        4              0.0                   -0.034598 2001-08-31  
        
        [5 rows x 189 columns]
      </code></pre>


    <div id="cell-6" class="cell" data-execution_count="2">
      <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">
      
        <span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select key features for analysis</span></span>
        <span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>selected_features = [</span>
        <span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'GDP'</span>, <span class="st">'CPI'</span>, <span class="st">'Unemployment'</span>, <span class="st">'FedFundsRate'</span>, <span class="st">'M2'</span>, <span class="st">'Umscent'</span>,  <span class="co"># Macroeconomic data</span></span>
        <span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MA_50_oil'</span>, <span class="st">'MA_50_gold'</span>, <span class="st">'MA_50_nasdaq'</span>, <span class="st">'MA_50_dow_jones'</span>,   <span class="co"># Technical indicators</span></span>
        <span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RSI_oil'</span>, <span class="st">'RSI_gold'</span>, <span class="st">'RSI_nasdaq'</span>, <span class="st">'RSI_dow_jones'</span>,           <span class="co"># RSI indicators</span></span>
        <span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MACD_oil'</span>, <span class="st">'MACD_gold'</span>, <span class="st">'MACD_nasdaq'</span>, <span class="st">'MACD_dow_jones'</span>,       <span class="co"># MACD indicators</span></span>
        <span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Future_Return_5D_oil'</span>, <span class="st">'Future_Return_5D_gold'</span>,                <span class="co"># Target variables</span></span>
        <span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Future_Return_5D_nasdaq'</span>, <span class="st">'Future_Return_5D_dow_jones'</span>,</span>
        <span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MA_50_sp500'</span>, <span class="st">'RSI_sp500'</span>, <span class="st">'MACD_sp500'</span>, <span class="st">'Future_Return_5D_sp500'</span>,</span>
        <span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Close_oil'</span>, <span class="st">'Close_gold'</span>, <span class="st">'Close_nasdaq'</span>, <span class="st">'Close_dow_jones'</span>, <span class="st">'Close_sp500'</span></span>
        <span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>]</span>
        
        <span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>selected_features_2 = [</span>
        <span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Close_oil'</span>, <span class="st">'Close_gold'</span>, <span class="st">'Close_nasdaq'</span>, <span class="st">'Close_dow_jones'</span>, <span class="st">'Close_sp500'</span>,</span>
        <span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MA_50_oil'</span>, <span class="st">'MA_50_gold'</span>, <span class="st">'MA_50_nasdaq'</span>, <span class="st">'MA_50_dow_jones'</span>,   <span class="co"># Technical indicators</span></span>
        <span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RSI_oil'</span>, <span class="st">'RSI_gold'</span>, <span class="st">'RSI_nasdaq'</span>, <span class="st">'RSI_dow_jones'</span>,           <span class="co"># RSI indicators</span></span>
        <span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MACD_oil'</span>, <span class="st">'MACD_gold'</span>, <span class="st">'MACD_nasdaq'</span>, <span class="st">'MACD_dow_jones'</span>,       <span class="co"># MACD indicators</span></span>
        <span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Future_Return_5D_oil'</span>, <span class="st">'Future_Return_5D_gold'</span>,                <span class="co"># Target variables</span></span>
        <span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Future_Return_5D_nasdaq'</span>, <span class="st">'Future_Return_5D_dow_jones'</span>,</span>
        <span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MA_50_sp500'</span>, <span class="st">'RSI_sp500'</span>, <span class="st">'MACD_sp500'</span>, <span class="st">'Future_Return_5D_sp500'</span></span>
        <span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>]</span>
        
        <span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the dataset to include only the selected features</span></span>
        <span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>macro_data = macro_data[selected_features]</span>
        
        <span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with missing values (if any remain after filling)</span></span>
        <span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>macro_data.dropna(inplace=<span class="va">True</span>)</span>
        
        <span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter the dataset to include only the selected features</span></span>
        <span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>asset_data = asset_data[selected_features_2]</span>
        
        <span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop rows with missing values (if any remain after filling)</span></span>
        <span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>asset_data.dropna(inplace=<span class="va">True</span>)</span>      </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
      <div class="cell-output cell-output-stdout">
      </div>
      </div>
    
    <div id="cell-6" class="cell" data-execution_count="2">
      <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">
      
        <span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Questions</span></span>
        <span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Are there any connections between the behavioral patterns of various markets (such as S&P 500, gold, crude oil, Nasdaq, etc.)?</span></span>
        <span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Is it possible to divide the market into different categories (such as high-risk vs. safe-haven assets) based on market characteristics (such as RSI, MACD, rainbows, etc.)?</span></span>
        
        <span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>save_path = <span class="st">"../../data/visualized-data"</span></span>
        <span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
        <span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>os.makedirs(save_path, exist_ok=<span class="va">True</span>)</span>
        
        <span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Calculate Daily Returns</span></span>
        <span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        
        <span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate daily returns from closing prices</span></span>
        <span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>returns = asset_data.filter(like=<span class="st">'Close'</span>).pct_change().dropna()</span>
        
        <span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute the correlation matrix</span></span>
        <span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>correlation_matrix = returns.corr()</span>
        <span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(asset_data.columns)</span>
        
        <span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the heatmap of the correlation matrix</span></span>
        <span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize=(<span class="nu">12</span>, <span class="nu">8</span>))</span>
        <span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>sns.heatmap(correlation_matrix, annot=<span class="va">True</span>, cmap=<span class="st">'coolwarm'</span>, fmt=<span class="st">'.2f'</span>)</span>
        <span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Market Correlation Matrix"</span>)</span>
        <span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'market_correlation_matrix.png'</span>))</span>
        <span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
        <span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
        
        <span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Remove Outliers</span></span>
        <span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        
        <span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate upper and lower limits (3 standard deviations from the mean)</span></span>
        <span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>upper_limit = returns.mean() + <span class="nu">3</span> * returns.std()</span>
        <span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>lower_limit = returns.mean() - <span class="nu">3</span> * returns.std()</span>
        
        <span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove outliers based on the calculated limits</span></span>
        <span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>filtered_returns = returns[(returns < upper_limit) & (returns > lower_limit)].dropna()</span>
        
        <span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Standardize the Data</span></span>
        <span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        
        <span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize the filtered returns</span></span>
        <span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>scaler = StandardScaler()</span>
        <span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>filtered_returns_scaled = scaler.fit_transform(filtered_returns)</span>
        
        <span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: PCA for Dimensionality Reduction</span></span>
        <span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        
        <span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PCA and reduce to 2 components</span></span>
        <span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>pca = PCA(n_components=<span class="nu">2</span>)</span>
        <span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>pca_data = pca.fit_transform(filtered_returns_scaled)</span>
        
        <span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the explained variance ratio of the first two principal components</span></span>
        <span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Explained variance ratio:"</span>, pca.explained_variance_ratio_)</span>
        
        <span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Visualize PCA Results</span></span>
        <span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        
        <span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Scatter plot of the PCA results</span></span>
        <span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize=(<span class="nu">8</span>, <span class="nu">6</span>))</span>
        <span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>plt.scatter(pca_data[:, <span class="nu">0</span>], pca_data[:, <span class="nu">1</span>], alpha=<span class="nu">0.5</span>)</span>
        <span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"PCA of Market Returns"</span>)</span>
        <span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Principal Component 1"</span>)</span>
        <span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Principal Component 2"</span>)</span>
        <span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'market_pca_results.png'</span>))</span>
        <span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
        <span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>plt.close()</span>      </code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
      <div class="cell-output cell-output-stdout">
      </div>
      </div>
      <pre><code>Index(['Close_oil', 'Close_gold', 'Close_nasdaq', 'Close_dow_jones',
        'Close_sp500', 'MA_50_oil', 'MA_50_gold', 'MA_50_nasdaq',
        'MA_50_dow_jones', 'RSI_oil', 'RSI_gold', 'RSI_nasdaq', 'RSI_dow_jones',
        'MACD_oil', 'MACD_gold', 'MACD_nasdaq', 'MACD_dow_jones',
        'Future_Return_5D_oil', 'Future_Return_5D_gold',
        'Future_Return_5D_nasdaq', 'Future_Return_5D_dow_jones', 'MA_50_sp500',
        'RSI_sp500', 'MACD_sp500', 'Future_Return_5D_sp500'],
       dtype='object')</code></pre>
      <div class="image-container">
        <img src="../../assets/market_correlation_matrix.png" class="distribution-image" alt="market_correlation_matrix" />
      </div>
      <pre><code>Explained variance ratio: [0.56997664 0.2343595 ]</code></pre>
      <div class="image-container">
        <img src="../../assets/market_pca_results.png" class="distribution-image" alt="market_pca_results.png" />

    </div>
    <div id="cell-6" class="cell" data-execution_count="2">
      <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">
      
        <span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Kmeans</span></span>
        <span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        
        <span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 1: Elbow Method to Determine Optimal k</span></span>
        <span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>inertia = []</span>
        <span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>range_k = <span class="fu">range</span>(<span class="nu">2</span>, <span class="nu">10</span>)</span>
        <span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> k <span class="kw">in</span> range_k:</span>
        <span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    kmeans = KMeans(n_clusters=k, random_state=<span class="nu">42</span>)</span>
        <span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    kmeans.fit(pca_data)</span>
        <span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    inertia.append(kmeans.inertia_)</span>
        
        <span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the Elbow Curve</span></span>
        <span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize=(<span class="nu">8</span>, <span class="nu">6</span>))</span>
        <span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>plt.plot(range_k, inertia, marker=<span class="st">'o'</span>)</span>
        <span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Elbow Method for K-Means"</span>)</span>
        <span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Number of Clusters (k)"</span>)</span>
        <span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Inertia"</span>)</span>
        <span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'kmeans_elbow_curve.png'</span>))</span>
        <span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
        <span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
        
        <span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 2: Fit K-Means with Optimal k</span></span>
        <span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>optimal_k = <span class="nu">3</span></span>
        <span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>kmeans = KMeans(n_clusters=optimal_k, random_state=<span class="nu">42</span>)</span>
        <span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>kmeans_labels = kmeans.fit_predict(pca_data)</span>
        
        <span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluate clustering with Silhouette Score</span></span>
        <span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>silhouette_avg = silhouette_score(pca_data, kmeans_labels)</span>
        <span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Silhouette Score:"</span>, silhouette_avg)</span>
        
        <span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 3: Visualize K-Means Clustering Results</span></span>
        <span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
        <span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize=(<span class="nu">8</span>, <span class="nu">6</span>))</span>
        <span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>plt.scatter(pca_data[:, <span class="nu">0</span>], pca_data[:, <span class="nu">1</span>], c=kmeans_labels, cmap=<span class="st">'viridis'</span>, alpha=<span class="nu">0.7</span>)</span>
        <span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"K-Means Clustering"</span>)</span>
        <span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Principal Component 1"</span>)</span>
        <span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Principal Component 2"</span>)</span>
        <span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>plt.colorbar(label=<span class="st">'Cluster'</span>)</span>
        <span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'kmeans_clustering_results.png'</span>))</span>
        <span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
        <span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
  <div class="image-container">
    <img src="../../assets/kmeans_elbow_curve.png" class="distribution-image" alt="kmeans_elbow_curve.png" />
  </div>
  <pre><code>Silhouette Score: 0.3465435410464012</code></pre>
  <div class="image-container">
    <img src="../../assets/kmeans_clustering_results.png" class="distribution-image" alt="kmeans_clustering_results" />
  </div>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="2">
  <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">
  
    <span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 7: PCA Dimensionality Reduction and Clustering</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>

<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DataFrame for PCA-transformed data</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>clustered_data = pd.DataFrame(pca_data, columns=[<span class="st">"PC1"</span>, <span class="st">"PC2"</span>])  <span class="co"># Principal Component Data</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>clustered_data[<span class="st">"Cluster"</span>] = kmeans_labels  <span class="co"># Add cluster labels</span></span>

<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean value of each principal component for each cluster</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>cluster_means = clustered_data.groupby(<span class="st">"Cluster"</span>).mean()</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Cluster Means:\n"</span>, cluster_means)</span>

<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the distribution of principal components by cluster</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>cluster_means.T.plot(kind=<span class="st">'bar'</span>, figsize=(<span class="nu">12</span>, <span class="nu">6</span>))</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Principal Component Distribution by Cluster"</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean Value"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Principal Component"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>plt.legend(title=<span class="st">"Cluster"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'pc_distribution_by_cluster.png'</span>))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>plt.close()</span>

<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the PCA loading matrix (components)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"PCA Components:\n"</span>, pca.components_)</span>

<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 8: Combine Cluster Labels with Original Feature Data</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>asset_data = asset_data.loc[filtered_returns.index] </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Length of asset_data after alignment:"</span>, <span class="fu">len</span>(asset_data))</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Length of kmeans_labels:"</span>, <span class="fu">len</span>(kmeans_labels))</span>

<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="fu">len</span>(asset_data) != <span class="fu">len</span>(kmeans_labels):</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    asset_data = asset_data.iloc[:<span class="fu">len</span>(kmeans_labels)]</span>

<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>original_clustered_data = asset_data.copy()</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>original_clustered_data[<span class="st">"Cluster"</span>] = kmeans_labels</span>

<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 9: Standardize the Feature Data</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>

<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract features (excluding the cluster labels)</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>features = original_clustered_data.drop(columns=[<span class="st">"Cluster"</span>])</span>

<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Use StandardScaler to standardize the feature data</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>scaler = StandardScaler()</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>features_scaled = scaler.fit_transform(features)</span>

<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert standardized data back to a DataFrame</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>features_scaled_df = pd.DataFrame(features_scaled, columns=features.columns)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>features_scaled_df[<span class="st">"Cluster"</span>] = original_clustered_data[<span class="st">"Cluster"</span>]  <span class="co"># Add cluster labels</span></span>

<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 10: Calculate Mean of Standardized Features by Cluster</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>

<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by cluster and calculate the mean of each feature</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>scaled_cluster_means = features_scaled_df.groupby(<span class="st">"Cluster"</span>).mean()</span>

<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 11: Visualize Clustered Feature Distributions</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>

<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the mean values of standardized features for each cluster</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize=(<span class="nu">14</span>, <span class="nu">8</span>))</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>scaled_cluster_means.T.plot(kind=<span class="st">"bar"</span>, figsize=(<span class="nu">14</span>, <span class="nu">8</span>))</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Standardized Feature Distribution by Cluster"</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean Value (Standardized)"</span>)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Feature"</span>)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>plt.legend(title=<span class="st">"Cluster"</span>, bbox_to_anchor=(<span class="nu">1.05</span>, <span class="nu">1</span>), loc=<span class="st">'upper left'</span>)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'feature_distribution_by_cluster.png'</span>))</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>plt.close()</span>

<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 12: Filter Features for Specific Analysis (e.g., RSI and MACD)</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>

<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Select only RSI and MACD-related features for focused analysis</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>selected_features = [col <span class="kw">for</span> col <span class="kw">in</span> features.columns <span class="kw">if</span> <span class="st">"RSI"</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">"MACD"</span> <span class="kw">in</span> col]</span>

<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the mean values of the selected features by cluster</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>filtered_cluster_means = scaled_cluster_means[selected_features]</span>

<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the distribution of the selected features by cluster</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize=(<span class="nu">14</span>, <span class="nu">8</span>))</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>filtered_cluster_means.T.plot(kind=<span class="st">"bar"</span>, figsize=(<span class="nu">14</span>, <span class="nu">8</span>))</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>plt.title("Standardized RSI and MACD Distribution by Cluster")</span>
<span id="cb1-71"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>plt.ylabel("Mean Value (Standardized)")</span>
<span id="cb1-71"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>plt.xlabel("Feature")</span>
<span id="cb1-71"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>plt.legend(title="Cluster", bbox_to_anchor=(1.05, 1), loc='upper left')</span>
<span id="cb1-71"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>  plt.tight_layout()</span>
<span id="cb1-71"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  plt.savefig(os.path.join(save_path, 'rsi_macd_distribution_by_cluster.png'))</span>
<span id="cb1-71"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>  plt.show()</span>
<span id="cb1-71"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  plt.close()</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cluster Means:
  PC1       PC2
Cluster                    
0        2.061786  0.017502
1       -0.091093 -0.008499
2       -2.607793  0.003936
</code></pre>
<div class="image-container">
<img src="../../assets/pc_distribution_by_cluster.png" class="distribution-image" alt="pc_distribution_by_cluster.png" />
</div>
<pre><code>PCA Components:
  [[ 1.40296075e-01 -4.31707754e-05  5.59111904e-01  5.68705657e-01
    5.86757841e-01]
  [ 6.65914113e-01  7.39689815e-01 -7.00063894e-02 -5.36870662e-02
   -4.04249546e-02]]
 Length of asset_data after alignment: 5650
 Length of kmeans_labels: 5650
</code></pre>
<div class="image-container">
<img src="../../assets/feature_distribution_by_cluster.png" class="distribution-image" alt="feature_distribution_by_cluster" />
<img src="../../assets/rsi_macd_distribution_by_cluster.png" class="distribution-image" alt="rsi_macd_distribution_by_cluster" />
</div>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="2">
  <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">
  
    <span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 13: Group and Filter Features by Categories</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>

<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Group features based on their categories</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Price-related features: Columns containing "Close" or "MA_50"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>price_features = [col <span class="kw">for</span> col <span class="kw">in</span> features.columns <span class="kw">if</span> <span class="st">"Close"</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">"MA_50"</span> <span class="kw">in</span> col]</span>

<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Technical indicators: Columns containing "RSI" or "MACD"</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>indicator_features = [col <span class="kw">for</span> col <span class="kw">in</span> features.columns <span class="kw">if</span> <span class="st">"RSI"</span> <span class="kw">in</span> col <span class="kw">or</span> <span class="st">"MACD"</span> <span class="kw">in</span> col]</span>

<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Target variables: Columns containing "Future_Return"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>target_features = [col <span class="kw">for</span> col <span class="kw">in</span> features.columns <span class="kw">if</span> <span class="st">"Future_Return"</span> <span class="kw">in</span> col]</span>

<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 14: Visualize Price Features by Cluster</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>

<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the standardized mean distribution of price-related features by cluster</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>scaled_cluster_means[price_features].T.plot(kind=<span class="st">"bar"</span>, figsize=(<span class="nu">14</span>, <span class="nu">8</span>))</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Standardized Price Features Distribution by Cluster"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean Value (Standardized)"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Feature"</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>plt.legend(title=<span class="st">"Cluster"</span>, bbox_to_anchor=(<span class="nu">1.05</span>, <span class="nu">1</span>), loc=<span class="st">'upper left'</span>)  <span class="co"># Place legend outside</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'price_features_by_cluster.png'</span>))</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>plt.close()</span>

<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 15: Visualize Technical Indicators by Cluster</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>

<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the standardized mean distribution of technical indicators (RSI and MACD) by cluster</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>scaled_cluster_means[indicator_features].T.plot(kind=<span class="st">"bar"</span>, figsize=(<span class="nu">14</span>, <span class="nu">8</span>))</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Standardized Technical Indicators Distribution by Cluster"</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean Value (Standardized)"</span>)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Feature"</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>plt.legend(title=<span class="st">"Cluster"</span>, bbox_to_anchor=(<span class="nu">1.05</span>, <span class="nu">1</span>), loc=<span class="st">'upper left'</span>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'target_variables_by_cluster.png'</span>))</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>plt.close()</span>

<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 16: Visualize Target Variables by Cluster</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>

<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the standardized mean distribution of target variables (Future_Return features) by cluster</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>scaled_cluster_means[target_features].T.plot(kind=<span class="st">"bar"</span>, figsize=(<span class="nu">14</span>, <span class="nu">8</span>))</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Standardized Target Variables Distribution by Cluster"</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean Value (Standardized)"</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Feature"</span>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>plt.legend(title=<span class="st">"Cluster"</span>, bbox_to_anchor=(<span class="nu">1.05</span>, <span class="nu">1</span>), loc=<span class="st">'upper left'</span>)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'technical_indicators_by_cluster.png'</span>))</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="image-container">
<img src="../../assets/price_features_by_cluster.png" class="distribution-image" alt="price_features_by_cluster.png" />
<img src="../../assets/target_variables_by_cluster.png" class="distribution-image" alt="target_variables_by_cluster" />
<img src="../../assets/technical_indicators_by_cluster.png" class="distribution-image" alt="technical_indicators_by_cluster" />
</div>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="2">
  <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">

<span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># question:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># How do macroeconomic data (such as GDP growth, CPI, unemployment rate, federal funds rate, etc.) affect the performance of different markets?</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Is the behavior of different markets driven by the same macroeconomic indicators?</span></span>

<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.tsa.stattools <span class="im">import</span> grangercausalitytests</span>

<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 1: Define Macro Features and Asset Returns</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define macroeconomic features</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>macro_features = [<span class="st">'GDP'</span>, <span class="st">'CPI'</span>, <span class="st">'Unemployment'</span>, <span class="st">'FedFundsRate'</span>]</span>

<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Define asset return columns (e.g., S&P 500, oil, gold, etc.)</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>asset_features = [<span class="st">'Close_sp500'</span>, <span class="st">'Close_oil'</span>, <span class="st">'Close_gold'</span>, <span class="st">'Close_nasdaq'</span>, <span class="st">'Close_dow_jones'</span>]</span>

<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 2: Calculate Correlations Between Macro Variables and Asset Returns</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty DataFrame to store correlations</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>correlations = pd.DataFrame(index=macro_features, columns=asset_features)</span>

<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each asset and calculate correlations with macro features</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> asset <span class="kw">in</span> asset_features:</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    correlations[asset] = macro_data[macro_features].corrwith(returns[asset])</span>

<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the correlations</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>correlations.plot(kind=<span class="st">'bar'</span>, figsize=(<span class="nu">12</span>, <span class="nu">8</span>), colormap=<span class="st">'viridis'</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Correlation Between Macro Variables and Asset Returns"</span>)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Correlation"</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Macro Variables"</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation=<span class="nu">45</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>plt.legend(title=<span class="st">"Assets"</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'macro_asset_correlations.png'</span>))</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>plt.close()</span>

<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   Step 3: Perform Granger Causality Tests for Each Asset</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Define max lag for Granger causality tests</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>max_lag = <span class="nu">4</span></span>

<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each asset and test causality with macro variables</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>granger_results = {}</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> asset <span class="kw">in</span> asset_features:</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> macro <span class="kw">in</span> macro_features:</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Align data and drop missing values</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        data = macro_data[[macro, asset]].dropna()</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Perform Granger causality test</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">f"Granger Causality Test: {macro} -> {asset}"</span>)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        result = grangercausalitytests(data, maxlag=max_lag, verbose=<span class="va">False</span>)</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        granger_results[(macro, asset)] = result</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Display p-values for each lag</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> lag, test_result <span class="kw">in</span> result.items():</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>            p_value = test_result[<span class="nu">0</span>][<span class="st">'ssr_chi2test'</span>][<span class="nu">1</span>]</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>            <span class="fu">print</span>(<span class="st">f"Lag {lag}: p-value = {p_value:.4f}"</span>)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">"-"</span> * <span class="nu">50</span>)</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="image-container">
<img src="../../assets/macro_asset_correlations.png" class="distribution-image" alt="macro_asset_correlations.png" />
</div>
<pre><code>Granger Causality Test: GDP -> Close_sp500
  Lag 1: p-value = 0.0137
  Lag 2: p-value = 0.0206
  Lag 3: p-value = 0.0013
  Lag 4: p-value = 0.0000
  --------------------------------------------------
  Granger Causality Test: CPI -> Close_sp500
  Lag 1: p-value = 0.0000
  Lag 2: p-value = 0.0001
  Lag 3: p-value = 0.0001
  Lag 4: p-value = 0.0001
  --------------------------------------------------
  Granger Causality Test: Unemployment -> Close_sp500
  Lag 1: p-value = 0.0229
  Lag 2: p-value = 0.0000
  Lag 3: p-value = 0.0000
  Lag 4: p-value = 0.0000
  --------------------------------------------------
  Granger Causality Test: FedFundsRate -> Close_sp500
  Lag 1: p-value = 0.0014
  Lag 2: p-value = 0.0780
  Lag 3: p-value = 0.0050
  Lag 4: p-value = 0.0812
  --------------------------------------------------
  Granger Causality Test: GDP -> Close_oil
  Lag 1: p-value = 0.6948
  Lag 2: p-value = 0.0066
  Lag 3: p-value = 0.0030
  Lag 4: p-value = 0.0012
  --------------------------------------------------
  Granger Causality Test: CPI -> Close_oil
  Lag 1: p-value = 0.1169
  Lag 2: p-value = 0.0000
  Lag 3: p-value = 0.0000
  Lag 4: p-value = 0.0000
  --------------------------------------------------
  Granger Causality Test: Unemployment -> Close_oil
  Lag 1: p-value = 0.5079
  Lag 2: p-value = 0.0001
  Lag 3: p-value = 0.0003
  Lag 4: p-value = 0.0002
  --------------------------------------------------
  Granger Causality Test: FedFundsRate -> Close_oil
  Lag 1: p-value = 0.0587
  Lag 2: p-value = 0.1552
  Lag 3: p-value = 0.0478
  Lag 4: p-value = 0.0884
  --------------------------------------------------
  Granger Causality Test: GDP -> Close_gold
  Lag 1: p-value = 0.5160
  Lag 2: p-value = 0.5347
  Lag 3: p-value = 0.1150
  Lag 4: p-value = 0.2512
  --------------------------------------------------
  Granger Causality Test: CPI -> Close_gold
  Lag 1: p-value = 0.9421
  Lag 2: p-value = 0.0844
  Lag 3: p-value = 0.2157
  Lag 4: p-value = 0.2093
  --------------------------------------------------
  Granger Causality Test: Unemployment -> Close_gold
  Lag 1: p-value = 0.5553
  Lag 2: p-value = 0.8625
  Lag 3: p-value = 0.8373
  Lag 4: p-value = 0.8699
  --------------------------------------------------
  Granger Causality Test: FedFundsRate -> Close_gold
  Lag 1: p-value = 0.0388
  Lag 2: p-value = 0.8806
  Lag 3: p-value = 0.6924
  Lag 4: p-value = 0.9076
  --------------------------------------------------
  Granger Causality Test: GDP -> Close_nasdaq
  Lag 1: p-value = 0.0118
  Lag 2: p-value = 0.0069
  Lag 3: p-value = 0.0009
  Lag 4: p-value = 0.0006
  --------------------------------------------------
  Granger Causality Test: CPI -> Close_nasdaq
  Lag 1: p-value = 0.0000
  Lag 2: p-value = 0.0004
  Lag 3: p-value = 0.0001
  Lag 4: p-value = 0.0002
  --------------------------------------------------
  Granger Causality Test: Unemployment -> Close_nasdaq
  Lag 1: p-value = 0.0375
  Lag 2: p-value = 0.0008
  Lag 3: p-value = 0.0001
  Lag 4: p-value = 0.0004
  --------------------------------------------------
  Granger Causality Test: FedFundsRate -> Close_nasdaq
  Lag 1: p-value = 0.0034
  Lag 2: p-value = 0.2720
  Lag 3: p-value = 0.0258
  Lag 4: p-value = 0.2066
  --------------------------------------------------
  Granger Causality Test: GDP -> Close_dow_jones
  Lag 1: p-value = 0.0044
  Lag 2: p-value = 0.0135
  Lag 3: p-value = 0.0008
  Lag 4: p-value = 0.0000
  --------------------------------------------------
  Granger Causality Test: CPI -> Close_dow_jones
  Lag 1: p-value = 0.0000
  Lag 2: p-value = 0.0000
  Lag 3: p-value = 0.0001
  Lag 4: p-value = 0.0000
  --------------------------------------------------
  Granger Causality Test: Unemployment -> Close_dow_jones
  Lag 1: p-value = 0.0211
  Lag 2: p-value = 0.0000
  Lag 3: p-value = 0.0000
  Lag 4: p-value = 0.0000
  --------------------------------------------------
  Granger Causality Test: FedFundsRate -> Close_dow_jones
  Lag 1: p-value = 0.0010
  Lag 2: p-value = 0.0155
  Lag 3: p-value = 0.0010
  Lag 4: p-value = 0.0260
  --------------------------------------------------
</code></pre>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="2">
  <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">
  
    <span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># question:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Are there ways to detect unusual behavior in markets (such as extreme volatility or abnormal returns)?</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># What technical indicators or macro factors might these abnormal behaviors be related to?</span></span>

<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Define a threshold for extreme volatility</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the threshold for extreme volatility (3 standard deviations)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>threshold = <span class="nu">3</span> * returns.std()</span>

<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify rows where any asset's return exceeds the threshold</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>extreme_volatility = returns[(returns > threshold).any(axis=<span class="nu">1</span>)]</span>

<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Plot extreme volatility for multiple assets</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># List of assets to visualize</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>assets_to_plot = [<span class="st">'Close_sp500'</span>, <span class="st">'Close_oil'</span>, <span class="st">'Close_gold'</span>, <span class="st">'Close_nasdaq'</span>, <span class="st">'Close_dow_jones'</span>]</span>

<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the figure and axes</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>fig, axes = plt.subplots(<span class="fu">len</span>(assets_to_plot), <span class="nu">1</span>, figsize=(<span class="nu">12</span>, <span class="nu">18</span>), sharex=<span class="va">True</span>)</span>

<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> i, asset <span class="kw">in</span> <span class="fu">enumerate</span>(assets_to_plot):</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    ax = axes[i]</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot returns for each asset</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    ax.plot(returns.index, returns[asset], label=<span class="st">f'{asset} Returns'</span>, color=<span class="st">'blue'</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Highlight extreme volatility</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        extreme_volatility.index, </span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        extreme_volatility[asset], </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        color=<span class="st">'red'</span>, </span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        label=<span class="st">'Extreme Volatility'</span>, </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        s=<span class="nu">10</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Customization</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">f"Extreme Volatility Detection - {asset}"</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">"Returns"</span>)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc=<span class="st">'upper left'</span>)</span>

<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a common x-label</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Time"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'extreme_volatility_detection.png'</span>))</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>plt.close()</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="image-container">
<img src="../../assets/extreme_volatility_detection.png" class="distribution-image" alt="extreme_volatility_detection.png" />
</div>
</div>
</div>
<div id="cell-6" class="cell" data-execution_count="2">
  <div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python">
  
    由于篇幅限制，我将分两部分展示完整的代码。这是第一部分：

```html
<span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># question</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Can different markets be divided into stable groups (e.g. risky assets vs. safe-haven assets)?</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Do these groupings help investors with asset allocation (e.g., diversification of investment risk)?</span></span>

<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cvxpy <span class="kw">as</span> cp</span>

<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Check for NaN or Inf in Returns Data</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for NaN or Inf values in returns</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Checking for NaN or Inf values in data..."</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"NaN values:"</span>, np.isnan(returns).sum().sum())</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Inf values:"</span>, np.isinf(returns).sum().sum())</span>

<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace Inf values with NaN for data cleaning</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>returns.replace([np.inf, -np.inf], np.nan, inplace=<span class="va">True</span>)</span>

<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove any rows containing NaN values</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>returns.dropna(inplace=<span class="va">True</span>)</span>

<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure using correct asset names</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>returns.columns = [<span class="st">'SP500'</span>, <span class="st">'Oil'</span>, <span class="st">'Gold'</span>, <span class="st">'Nasdaq'</span>, <span class="st">'Dow_Jones'</span>]</span>

<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Compute Returns Statistics</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate mean returns and volatility for each asset</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>asset_stats = pd.DataFrame({</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>   <span class="st">'Mean Return'</span>: returns.mean(),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>   <span class="st">'Volatility'</span>: returns.std()</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>})</span>

<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Handle any remaining extreme or missing values</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>asset_stats.replace([np.inf, -np.inf], np.nan, inplace=<span class="va">True</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>asset_stats.fillna(<span class="nu">0</span>, inplace=<span class="va">True</span>)  <span class="co"># Replace NaN with 0 (or use mean/median if needed)</span></span>

<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: K-Means Clustering for Asset Grouping</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize features for clustering</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>scaler = StandardScaler()</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>scaled_stats = scaler.fit_transform(asset_stats)</span>

<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform K-Means clustering with 3 clusters</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>kmeans = KMeans(n_clusters=<span class="nu">3</span>, random_state=<span class="nu">42</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>asset_stats[<span class="st">'Cluster'</span>] = kmeans.fit_predict(scaled_stats)</span>

<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize clustering results with asset labels</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize=(<span class="nu">8</span>, <span class="nu">6</span>))</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>scatter = plt.scatter(asset_stats[<span class="st">'Volatility'</span>], </span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>                    asset_stats[<span class="st">'Mean Return'</span>], </span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>                    c=asset_stats[<span class="st">'Cluster'</span>], </span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                    cmap=<span class="st">'viridis'</span>, </span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>                    s=<span class="nu">50</span>)</span>

<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Add asset labels to the plot</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> idx, row <span class="kw">in</span> asset_stats.iterrows():</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>   plt.annotate(idx, </span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>               (row[<span class="st">'Volatility'</span>], row[<span class="st">'Mean Return'</span>]),</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>               xytext=(<span class="nu">5</span>, <span class="nu">5</span>), </span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>               textcoords=<span class="st">'offset points'</span>)</span>

<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Asset Clustering Based on Return and Volatility"</span>)</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Volatility"</span>)</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Mean Return"</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>plt.colorbar(label=<span class="st">'Cluster'</span>)</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'asset_clustering.png'</span>))</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>plt.close()</span>

<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Clip Extreme Values for Stability</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Limit extreme values for more stable analysis</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>returns = returns.clip(lower=-<span class="nu">0.5</span>, upper=<span class="nu">0.5</span>)</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>asset_stats[<span class="st">'Volatility'</span>] = asset_stats[<span class="st">'Volatility'</span>].clip(upper=<span class="nu">50</span>)</span>

<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Recalculate statistics after clipping</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>asset_stats = pd.DataFrame({</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>   <span class="st">'Mean Return'</span>: returns.mean(),</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>   <span class="st">'Volatility'</span>: returns.std()</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>})</span>

<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Adjust Target Return</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate target return as mean across all assets</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>target_return = asset_stats[<span class="st">'Mean Return'</span>].mean()</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"Target Return:"</span>, target_return)</span>

<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Portfolio Optimization</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> optimize_portfolio(returns, target_return):</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>   <span class="st">"""</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a><span class="st">   Optimize portfolio weights to minimize risk while meeting target return</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="st">   Parameters:</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a><span class="st">   returns: DataFrame of asset returns</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="st">   target_return: float, minimum required portfolio return</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="st">   </span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="st">   Returns:</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a><span class="st">   array of optimal weights</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="st">   """</span></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>   n_assets = returns.shape[<span class="nu">1</span>]</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>   mu = returns.mean().values  <span class="co"># Expected returns</span></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>   cov_matrix = returns.cov().values  <span class="co"># Covariance matrix</span></span>

<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Define optimization variables</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>   weights = cp.Variable(n_assets)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>   portfolio_return = mu.T @ weights</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>   portfolio_risk = cp.quad_form(weights, cov_matrix)</span>

<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Set optimization constraints</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>   constraints = [cp.sum(weights) == <span class="nu">1</span>, weights >= <span class="nu">0</span>, portfolio_return >= target_return]</span>

<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>   <span class="co"># Minimize portfolio variance subject to constraints</span></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>   problem = cp.Problem(cp.Minimize(portfolio_risk), constraints)</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>   problem.solve()</span>

<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>   <span class="kw">return</span> weights.value</span>

<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-optimize portfolio with target return</span></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>optimal_weights = optimize_portfolio(returns, target_return)</span>

<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Display optimization results</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>portfolio = pd.DataFrame({</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>   <span class="st">'Asset'</span>: returns.columns,</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>   <span class="st">'Optimal Weight'</span>: optimal_weights</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(portfolio)</span>

<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Visualize Portfolio Weights</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="co"># ----------------------------------------------</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Create bar plot of optimal weights</span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize=(<span class="nu">8</span>, <span class="nu">6</span>))</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>plt.bar(portfolio[<span class="st">'Asset'</span>], portfolio[<span class="st">'Optimal Weight'</span>], color=<span class="st">'skyblue'</span>)</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Improved Optimal Portfolio Weights"</span>)</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">"Assets"</span>)</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Weight"</span>)</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation=<span class="nu">45</span>)</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>plt.savefig(os.path.join(save_path, <span class="st">'portfolio_weights.png'</span>))</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>plt.close()</span>

</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<div class="image-container">
<img src="../../assets/asset_clustering.png" class="distribution-image" alt="asset_clustering.png" />
</div>
<pre><code>Target Return: 0.00040986463585241246
  Asset  Optimal Weight
0      SP500        0.003428
1        Oil        0.549058
2       Gold        0.080817
3     Nasdaq        0.313445
4  Dow_Jones        0.053255
</code></pre>
<div class="image-container">
<img src="../../assets/portfolio_weights.png" class="distribution-image" alt="portfolio_weights" />
</div>
</div>
</div>


  </div>

</div>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body" data-entry-spacing="0" data-line-spacing="2" role="list">
<div id="ref-gpt4o" class="csl-entry" role="listitem">
<div class="csl-left-margin">1. </div><div class="csl-right-inline">ChatGPT, version-4o, OpenAI, may-13, 2024, chat.openai.com.</div>
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>